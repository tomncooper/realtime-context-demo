flowchart TB

    Query["'How many shipments are in transit?'"]
    MCPQuery["Claude Code / Other AI Agent"]

    subgraph API["Query API (Quarkus)"]
        direction LR
        Chat["ChatResource<br/>POST /api/chat"]
        MCPEndpoint["MCP Server<br/>POST /mcp"]
        Assistant["LogisticsAssistant<br/>@RegisterAiService"]
        Memory["Session Memory<br/>(20 messages)"]
    end

    subgraph LLM["LLM Provider"]
        Model["Ollama / OpenAI / Anthropic"]
    end

    subgraph Tools["LangChain4j Tools"]
        ST["ShipmentTools"]
        CT["CustomerTools"]
        ToolsEtc["..."]
    end

    subgraph MCPTools["MCP Tools"]
        SMT["ShipmentMcpTools"]
        CMT["CustomerMcpTools"]
        MCPEtc["..."]
    end

    TOS["ToolOperationsService"]

    subgraph Services["Query Services"]
        KS["KafkaStreamsQueryService"]
        PS["PostgresQueryService"]
        QO["QueryOrchestrationService"]
    end

    subgraph Data["Data Stores"]
        Kafka["Kafka Streams<br/>State Stores"]
        PG["PostgreSQL<br/>Reference Data"]
    end

    %% Internal LLM Flow
    Query --> Chat
    Chat --> Assistant
    Assistant <--> Memory
    Assistant <--> Model

    Model <-.->|"tool calls"| ST
    Model <-.->|"tool calls"| CT
    Model <-.->|"tool calls"| ToolsEtc

    %% External MCP Flow
    MCPQuery -->|"MCP JSON-RPC"| MCPEndpoint
    MCPEndpoint --> SMT
    MCPEndpoint --> CMT
    MCPEndpoint --> MCPEtc

    %% Tools to shared service
    ST --> TOS
    CT --> TOS
    ToolsEtc --> TOS
    SMT --> TOS
    CMT --> TOS
    MCPEtc --> TOS

    %% Shared service to query services
    TOS --> KS
    TOS --> PS
    TOS --> QO

    QO --> KS
    QO --> PS

    %% Query services to data stores
    KS --> Kafka
    PS --> PG
